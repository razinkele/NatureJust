# NatureJust-EU Shiny App Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Scaffold a complete golem-based R Shiny prototype with 6 modules (Home, Spatial Equity, Scenarios, Justice, Governance, Indicators) using mock data and bslib theming.

**Architecture:** golem R package structure with bslib::page_navbar for tab navigation. Each module is a separate Shiny module file (mod_*.R). Mock data generators in fct_mock_data.R. Custom CSS/JS for NFF triangle. Deployable via Docker or shinyapps.io.

**Tech Stack:** R, shiny, golem, bslib, bsicons, leaflet, sf, plotly, ggplot2, dplyr, tidyr, DT, shinyWidgets, rnaturalearth, rmarkdown

**Important:** R is not in the system PATH. All R commands must be run inside RStudio or an R-aware terminal. File creation will be done by writing files directly (not via golem::create_golem), but following exact golem conventions.

---

### Task 1: Create golem package skeleton

**Files:**
- Create: `DESCRIPTION`
- Create: `NAMESPACE`
- Create: `NatureJust.Rproj`
- Create: `R/run_app.R`
- Create: `R/app_config.R`
- Create: `.Rbuildignore`

**Step 1: Write DESCRIPTION file**

```
Package: NatureJust
Title: NatureJust-EU Decision-Support Tool for Equitable Biodiversity Governance
Version: 0.0.0.9000
Authors@R:
    person("Antonello", "", role = c("aut", "cre"),
           email = "antonello@example.com")
Description: A Shiny decision-support tool for marine planners, fisheries
    managers, regional governments, and civil society organisations. Built on
    the Nature Futures Framework (NFF), Global Biodiversity Framework (GBF),
    and environmental justice principles.
License: MIT + file LICENSE
Encoding: UTF-8
LazyData: true
Roxygen: list(markdown = TRUE)
RoxygenNote: 7.3.1
Imports:
    shiny (>= 1.8.0),
    golem (>= 0.4.0),
    bslib (>= 0.7.0),
    bsicons,
    config (>= 0.3.2),
    leaflet,
    sf,
    plotly,
    ggplot2,
    dplyr,
    tidyr,
    purrr,
    DT,
    shinyWidgets,
    rnaturalearth,
    rnaturalearthdata,
    rmarkdown,
    knitr,
    htmltools
Suggests:
    testthat (>= 3.0.0),
    spelling
Config/testthat/edition: 3
Language: en-US
```

**Step 2: Write NAMESPACE**

```
# Generated by roxygen2: do not edit by hand
importFrom(shiny,NS,tagList)
export(run_app)
```

**Step 3: Write NatureJust.Rproj**

```
Version: 1.0

RestoreWorkspace: Default
SaveWorkspace: Default
AlwaysSaveHistory: Default

EnableCodeIndexing: Yes
UseSpacesForTab: Yes
NumSpacesForTab: 2
Encoding: UTF-8

RnwWeave: Sweave
LaTeX: pdfLaTeX

BuildType: Package
PackageUseDevtools: Yes
PackageInstallArgs: --no-multiarch --with-keep.source
```

**Step 4: Write R/run_app.R**

```r
#' Run the Shiny Application
#'
#' @param ... arguments to pass to golem_opts.
#' @inheritParams shiny::shinyApp
#' @export
run_app <- function(
    onStart = NULL,
    options = list(),
    enableBookmarking = NULL,
    uiPattern = "/",
    ...
) {
  with_golem_options(
    app = shiny::shinyApp(
      ui = app_ui,
      server = app_server,
      onStart = onStart,
      options = options,
      enableBookmarking = enableBookmarking,
      uiPattern = uiPattern
    ),
    golem_opts = list(...)
  )
}
```

**Step 5: Write R/app_config.R**

```r
#' Access files in the current app
#'
#' @param ... Character vectors, specifying subdirectory and file(s)
#'   within your package. The default, none, returns the root of the app.
#' @noRd
app_sys <- function(...) {
  system.file(..., package = "NatureJust")
}

#' Read App Config
#'
#' @param value Value to retrieve from the config file.
#' @param config GOLEM_CONFIG_ACTIVE value. If unset, defaults to
#'   R_CONFIG_ACTIVE or "default".
#' @param use_parent Logical, scan parent directories for config.
#' @noRd
get_golem_config <- function(
    value,
    config = Sys.getenv("GOLEM_CONFIG_ACTIVE", Sys.getenv("R_CONFIG_ACTIVE", "default")),
    use_parent = TRUE
) {
  config::get(
    value = value,
    config = config,
    file = app_sys("golem-config.yml"),
    use_parent = use_parent
  )
}
```

**Step 6: Write .Rbuildignore**

```
^.*\.Rproj$
^\.Rproj\.user$
^data-raw$
^dev$
^docs$
^Dockerfile$
^\.github$
^\.claude$
```

**Step 7: Create directory structure**

```bash
mkdir -p R inst/app/www inst/golem-config data-raw data tests/testthat man dev
```

**Step 8: Write inst/golem-config.yml**

```yaml
default:
  golem_name: NatureJust
  golem_version: 0.0.0.9000
  app_prod: no
production:
  app_prod: yes
```

**Step 9: Write LICENSE**

```
MIT License

Copyright (c) 2026 NatureJust-EU

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
```

---

### Task 2: Write main app UI and server

**Files:**
- Create: `R/app_ui.R`
- Create: `R/app_server.R`

**Step 1: Write R/app_ui.R**

```r
#' The application User-Interface
#'
#' @param request Internal parameter for `{shiny}`.
#' @import shiny
#' @noRd
app_ui <- function(request) {
  tagList(
    golem_add_external_resources(),
    bslib::page_navbar(
      title = tags$span(
        bsicons::bs_icon("globe-europe-africa"),
        "NatureJust-EU"
      ),
      id = "main_nav",
      theme = bslib::bs_theme(
        version = 5,
        bootswatch = "flatly",
        primary = "#2c7fb8",
        success = "#41ae76",
        info = "#7bccc4",
        warning = "#f0ad4e",
        danger = "#d9534f",
        "font-size-base" = "0.95rem"
      ),
      fillable = TRUE,
      bslib::nav_panel(
        title = "Home",
        icon = bsicons::bs_icon("house"),
        mod_home_ui("home")
      ),
      bslib::nav_panel(
        title = "Spatial Equity",
        icon = bsicons::bs_icon("map"),
        mod_spatial_ui("spatial")
      ),
      bslib::nav_panel(
        title = "Scenarios",
        icon = bsicons::bs_icon("sliders"),
        mod_scenarios_ui("scenarios")
      ),
      bslib::nav_panel(
        title = "Justice",
        icon = bsicons::bs_icon("shield-check"),
        mod_justice_ui("justice")
      ),
      bslib::nav_panel(
        title = "Governance",
        icon = bsicons::bs_icon("bank"),
        mod_governance_ui("governance")
      ),
      bslib::nav_panel(
        title = "Indicators",
        icon = bsicons::bs_icon("graph-up"),
        mod_dashboard_ui("dashboard")
      ),
      bslib::nav_spacer(),
      bslib::nav_item(
        bslib::input_dark_mode(id = "dark_mode")
      )
    )
  )
}

#' Add external Resources to the Application
#'
#' @import shiny
#' @importFrom golem add_resource_path activate_js favicon bundle_resources
#' @noRd
golem_add_external_resources <- function() {
  add_resource_path("www", app_sys("app/www"))
  tags$head(
    favicon(),
    bundle_resources(
      path = app_sys("app/www"),
      app_title = "NatureJust-EU"
    )
  )
}
```

**Step 2: Write R/app_server.R**

```r
#' The application server-side
#'
#' @param input,output,session Internal parameters for `{shiny}`.
#' @import shiny
#' @noRd
app_server <- function(input, output, session) {
  mod_home_server("home", parent_session = session)
  mod_spatial_server("spatial")
  mod_scenarios_server("scenarios")
  mod_justice_server("justice")
  mod_governance_server("governance")
  mod_dashboard_server("dashboard")
}
```

---

### Task 3: Write mock data generators

**Files:**
- Create: `R/fct_mock_data.R`

**Step 1: Write R/fct_mock_data.R**

This file contains all mock data factories used across modules. Each function is self-contained and returns a data frame or sf object.

```r
#' Generate mock European NUTS2 regions with vulnerability scores
#' @return sf object with NUTS2-like polygons and mock indicators
#' @noRd
mock_nuts2_data <- function() {
  europe <- rnaturalearth::ne_countries(
    scale = 50,
    continent = "Europe",
    returnclass = "sf"
  )
  europe <- europe[!europe$sovereignt %in% c("Russia", "Iceland"), ]
  europe <- sf::st_transform(europe, 4326)

  set.seed(42)
  europe$vulnerability <- round(runif(nrow(europe), 0, 1), 2)
  europe$fisheries_dep <- round(runif(nrow(europe), 0, 1), 2)
  europe$conservation_pressure <- round(runif(nrow(europe), 0, 1), 2)
  europe$mpa_coverage <- round(runif(nrow(europe), 0.05, 0.45), 2)

  sea_basins <- c("Baltic", "North Sea", "Atlantic", "Mediterranean", "Black Sea")
  europe$sea_basin <- sample(sea_basins, nrow(europe), replace = TRUE)

  ecosystem_types <- c("Coastal", "Pelagic", "Deep-sea", "Estuarine", "Reef")
  europe$ecosystem_type <- sample(ecosystem_types, nrow(europe), replace = TRUE)

  europe
}

#' Generate mock MPA polygons
#' @return sf object with random MPA rectangles across Europe
#' @noRd
mock_mpa_data <- function(n = 30) {
  set.seed(123)
  lons <- runif(n, -10, 30)
  lats <- runif(n, 35, 65)
  size <- runif(n, 0.5, 2)

  polys <- lapply(seq_len(n), function(i) {
    coords <- matrix(c(
      lons[i], lats[i],
      lons[i] + size[i], lats[i],
      lons[i] + size[i], lats[i] + size[i] * 0.6,
      lons[i], lats[i] + size[i] * 0.6,
      lons[i], lats[i]
    ), ncol = 2, byrow = TRUE)
    sf::st_polygon(list(coords))
  })

  sf::st_sf(
    name = paste("MPA", seq_len(n)),
    designation = sample(
      c("Natura 2000", "National MPA", "Proposed 30x30"),
      n, replace = TRUE
    ),
    geometry = sf::st_sfc(polys, crs = 4326)
  )
}

#' Generate mock scenario projection data
#' @param nff_weights Named numeric vector c(NfN=, NfS=, NaC=) summing to 100
#' @param region Character region name
#' @return Data frame with yearly projections for 4 indicators
#' @noRd
mock_scenario_data <- function(nff_weights = c(NfN = 34, NfS = 33, NaC = 33),
                                region = "Mediterranean") {
  set.seed(sum(nff_weights) + nchar(region))
  years <- 2025:2050

  # NFF weights influence trends
  nfn <- nff_weights["NfN"] / 100
  nfs <- nff_weights["NfS"] / 100
  nac <- nff_weights["NaC"] / 100

  data.frame(
    year = rep(years, 4),
    indicator = rep(
      c("Habitat Condition", "Ecosystem Services",
        "Livelihoods & Employment", "Equity Score"),
      each = length(years)
    ),
    value = c(
      # Habitat: improves with NfN weight
      cumsum(rnorm(length(years), mean = 0.02 * nfn, sd = 0.01)) + 0.5,
      # Ecosystem services: improves with NfS weight
      cumsum(rnorm(length(years), mean = 0.015 * nfs, sd = 0.01)) + 0.5,
      # Livelihoods: improves with NaC weight, slight NfN penalty
      cumsum(rnorm(length(years), mean = 0.01 * nac - 0.005 * nfn, sd = 0.01)) + 0.6,
      # Equity: balanced approach is best
      cumsum(rnorm(length(years), mean = 0.01 * (1 - max(abs(nfn - nfs), abs(nfs - nac), abs(nfn - nac))), sd = 0.008)) + 0.5
    ),
    region = region
  )
}

#' Generate mock justice scores for an intervention
#' @param intervention Character name of intervention
#' @return Data frame with 4 justice dimension scores
#' @noRd
mock_justice_scores <- function(intervention = "MPA Establishment") {
  set.seed(nchar(intervention))

  dimensions <- c("Distributional", "Procedural", "Recognitional", "Restorative")
  scores <- pmin(pmax(rnorm(4, mean = 0.6, sd = 0.25), 0), 1)

  data.frame(
    dimension = dimensions,
    score = round(scores, 2),
    status = dplyr::case_when(
      scores >= 0.7 ~ "green",
      scores >= 0.4 ~ "amber",
      TRUE ~ "red"
    ),
    description = c(
      "Fair distribution of costs and benefits across communities",
      "Meaningful participation of affected stakeholders in decision-making",
      "Recognition of diverse knowledge systems and cultural values",
      "Remediation of historical environmental injustices"
    )
  )
}

#' Mock list of interventions
#' @return Character vector of intervention names
#' @noRd
mock_interventions <- function() {
  c(
    "MPA Establishment",
    "Seagrass Restoration",
    "Offshore Wind Siting",
    "Fishing Quota Redistribution",
    "Coastal Wetland Conservation",
    "Coral Reef Protection",
    "Mangrove Replanting",
    "Marine Litter Reduction",
    "Sustainable Aquaculture Zone",
    "Deep-Sea Mining Moratorium"
  )
}

#' Generate mock funding instrument matrix
#' @return Data frame of interventions vs EU funding eligibility
#' @noRd
mock_funding_matrix <- function() {
  interventions <- mock_interventions()
  funds <- c("EMFAF", "LIFE", "Cohesion Fund", "EARDF", "Just Transition Fund")

  set.seed(99)
  mat <- matrix(
    sample(c("Eligible", "Partial", "Not eligible"), length(interventions) * length(funds), replace = TRUE,
           prob = c(0.4, 0.3, 0.3)),
    nrow = length(interventions)
  )

  df <- as.data.frame(mat)
  names(df) <- funds
  df$Intervention <- interventions
  df[, c("Intervention", funds)]
}

#' Generate mock indicator time series
#' @param region Character region name
#' @return Data frame with indicator values over time with confidence bands
#' @noRd
mock_indicator_timeseries <- function(region = "Mediterranean") {
  set.seed(nchar(region))
  years <- 2010:2025
  indicators <- c(
    "Marine Biodiversity Index",
    "Habitat Condition Score",
    "Ecosystem Services Value",
    "Community Wellbeing Index",
    "Governance Effectiveness"
  )

  do.call(rbind, lapply(indicators, function(ind) {
    trend <- cumsum(rnorm(length(years), mean = 0.01, sd = 0.03))
    value <- 0.5 + trend
    data.frame(
      year = years,
      indicator = ind,
      value = round(value, 3),
      lower = round(value - abs(rnorm(length(years), 0.05, 0.02)), 3),
      upper = round(value + abs(rnorm(length(years), 0.05, 0.02)), 3),
      region = region,
      gbf_target = round(runif(1, 0.6, 0.9), 2)
    )
  }))
}
```

---

### Task 4: Write custom CSS and JS assets

**Files:**
- Create: `inst/app/www/custom.css`
- Create: `inst/app/www/nff_triangle.js`

**Step 1: Write inst/app/www/custom.css**

```css
/* NatureJust-EU Custom Styles */

/* NFF Triangle */
.nff-triangle-container {
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 2rem;
}

.nff-triangle svg {
  max-width: 400px;
  cursor: pointer;
}

.nff-triangle .vertex {
  fill: #2c7fb8;
  transition: fill 0.2s, r 0.2s;
}

.nff-triangle .vertex:hover {
  fill: #41ae76;
  r: 14;
}

.nff-triangle .edge-label {
  font-size: 11px;
  fill: #555;
  pointer-events: none;
}

.nff-triangle .vertex-label {
  font-size: 13px;
  font-weight: 600;
  fill: #2c3e50;
  pointer-events: none;
}

/* Justice Scorecard */
.justice-card {
  border-left: 4px solid #ccc;
  transition: border-color 0.3s;
}

.justice-card.status-green {
  border-left-color: #41ae76;
}

.justice-card.status-amber {
  border-left-color: #f0ad4e;
}

.justice-card.status-red {
  border-left-color: #d9534f;
}

/* Traffic light indicators */
.traffic-light {
  display: inline-block;
  width: 16px;
  height: 16px;
  border-radius: 50%;
  margin-right: 6px;
  vertical-align: middle;
}

.traffic-light.green  { background-color: #41ae76; }
.traffic-light.amber  { background-color: #f0ad4e; }
.traffic-light.red    { background-color: #d9534f; }

/* Home page */
.home-hero {
  text-align: center;
  padding: 2rem 1rem;
}

.home-hero h1 {
  color: #2c7fb8;
  font-weight: 700;
}

.home-hero .subtitle {
  color: #6c757d;
  font-size: 1.1rem;
  max-width: 700px;
  margin: 1rem auto;
}

/* Framework cards on home */
.framework-card {
  text-align: center;
  padding: 1.5rem;
}

.framework-card .card-icon {
  font-size: 2.5rem;
  color: #2c7fb8;
  margin-bottom: 0.75rem;
}
```

**Step 2: Write inst/app/www/nff_triangle.js**

```javascript
// NFF Triangle interactive navigation
$(document).on('click', '.nff-vertex', function() {
  var target = $(this).data('target');
  // Use bslib's navbar API to switch tabs
  Shiny.setInputValue('main_nav', target, {priority: 'event'});

  // Fallback: click the navbar link directly
  var navLinks = document.querySelectorAll('.navbar-nav .nav-link');
  navLinks.forEach(function(link) {
    if (link.textContent.trim().indexOf(target) !== -1) {
      link.click();
    }
  });
});
```

---

### Task 5: Write Module 0 — Home & NFF Triangle

**Files:**
- Create: `R/mod_home.R`

**Step 1: Write R/mod_home.R**

```r
#' Home module UI
#'
#' @param id Module namespace id
#' @noRd
mod_home_ui <- function(id) {
  ns <- NS(id)

  tagList(
    div(
      class = "home-hero",
      h1("NatureJust-EU"),
      p(class = "subtitle",
        "A Decision-Support Tool for Equitable Biodiversity Governance"),
      p(class = "text-muted",
        "Integrating the Nature Futures Framework, Global Biodiversity Framework,",
        "and environmental justice principles for marine spatial planning.")
    ),

    bslib::layout_column_wrap(
      width = 1/2,
      heights_equal = "row",

      # NFF Triangle
      bslib::card(
        bslib::card_header(
          class = "bg-primary text-white",
          "Nature Futures Framework"
        ),
        bslib::card_body(
          class = "nff-triangle-container",
          HTML('
            <div class="nff-triangle">
              <svg viewBox="0 0 400 370" xmlns="http://www.w3.org/2000/svg">
                <!-- Triangle -->
                <polygon points="200,30 370,340 30,340"
                         fill="none" stroke="#2c7fb8" stroke-width="2"/>

                <!-- Vertices (clickable) -->
                <circle class="nff-vertex vertex" data-target="Spatial Equity"
                        cx="200" cy="30" r="12"/>
                <circle class="nff-vertex vertex" data-target="Scenarios"
                        cx="370" cy="340" r="12"/>
                <circle class="nff-vertex vertex" data-target="Justice"
                        cx="30" cy="340" r="12"/>

                <!-- Vertex labels -->
                <text class="vertex-label" x="200" y="15"
                      text-anchor="middle">Nature for Nature</text>
                <text class="vertex-label" x="395" y="355"
                      text-anchor="start">Nature for Society</text>
                <text class="vertex-label" x="5" y="355"
                      text-anchor="end">Nature as Culture</text>

                <!-- Edge labels -->
                <text class="edge-label" x="290" y="175"
                      text-anchor="middle" transform="rotate(30, 290, 175)">
                  Biodiversity &amp; Livelihoods</text>
                <text class="edge-label" x="110" y="175"
                      text-anchor="middle" transform="rotate(-30, 110, 175)">
                  Cultural &amp; Ecological</text>
                <text class="edge-label" x="200" y="360"
                      text-anchor="middle">Social &amp; Cultural Values</text>
              </svg>
            </div>
          ')
        ),
        bslib::card_footer(
          class = "text-muted text-center",
          "Click a vertex to navigate to the relevant module"
        )
      ),

      # Framework explanation
      bslib::card(
        bslib::card_header(
          class = "bg-primary text-white",
          "How It Works"
        ),
        bslib::card_body(
          bslib::accordion(
            id = ns("framework_accordion"),
            bslib::accordion_panel(
              "Global Biodiversity Framework (GBF)",
              icon = bsicons::bs_icon("globe"),
              p("The Kunming-Montreal GBF sets 23 targets for 2030, including",
                "the 30x30 target to protect 30% of land and sea areas.",
                "NatureJust-EU tracks compliance and equity implications.")
            ),
            bslib::accordion_panel(
              "Nature Futures Framework (NFF)",
              icon = bsicons::bs_icon("tree"),
              p("The NFF organises biodiversity futures along three value",
                "perspectives: Nature for Nature (intrinsic), Nature for Society",
                "(instrumental), and Nature as Culture (relational).",
                "Scenarios explore trade-offs between these perspectives.")
            ),
            bslib::accordion_panel(
              "Environmental Justice",
              icon = bsicons::bs_icon("balance-scale" ),
              p("Four dimensions of justice guide assessment: distributional",
                "(fair sharing of costs/benefits), procedural (inclusive",
                "decision-making), recognitional (diverse knowledge systems),",
                "and restorative (remedying historical harms).")
            )
          )
        )
      )
    ),

    # Module overview cards
    h4("Explore the Modules", class = "text-center mt-4 mb-3"),
    bslib::layout_column_wrap(
      width = 1/3,
      bslib::value_box(
        title = "Spatial Equity",
        value = "Diagnostic",
        showcase = bsicons::bs_icon("map"),
        theme = "primary",
        p("Map conservation needs against socio-economic vulnerability")
      ),
      bslib::value_box(
        title = "Scenario Explorer",
        value = "NFF Futures",
        showcase = bsicons::bs_icon("sliders"),
        theme = "info",
        p("Compare biodiversity futures under different value perspectives")
      ),
      bslib::value_box(
        title = "Justice Assessment",
        value = "4 Dimensions",
        showcase = bsicons::bs_icon("shield-check"),
        theme = "success",
        p("Evaluate interventions against environmental justice criteria")
      )
    )
  )
}

#' Home module server
#'
#' @param id Module namespace id
#' @param parent_session The parent session for navbar navigation
#' @noRd
mod_home_server <- function(id, parent_session = NULL) {
  moduleServer(id, function(input, output, session) {
    # Navigation from NFF triangle is handled via JS in nff_triangle.js
    # The JS sets the navbar tab directly
  })
}
```

---

### Task 6: Write Module 1 — Spatial Equity Diagnostic

**Files:**
- Create: `R/mod_spatial.R`

**Step 1: Write R/mod_spatial.R**

```r
#' Spatial Equity module UI
#' @param id Module namespace id
#' @noRd
mod_spatial_ui <- function(id) {
  ns <- NS(id)

  bslib::layout_sidebar(
    sidebar = bslib::sidebar(
      title = "Filters",
      width = 280,
      shinyWidgets::pickerInput(
        ns("country"), "Country",
        choices = NULL,
        multiple = TRUE,
        options = shinyWidgets::pickerOptions(
          actionsBox = TRUE,
          liveSearch = TRUE,
          selectedTextFormat = "count > 3"
        )
      ),
      selectInput(
        ns("sea_basin"), "Sea Basin",
        choices = c("All", "Baltic", "North Sea", "Atlantic",
                    "Mediterranean", "Black Sea")
      ),
      selectInput(
        ns("ecosystem"), "Ecosystem Type",
        choices = c("All", "Coastal", "Pelagic", "Deep-sea",
                    "Estuarine", "Reef")
      ),
      hr(),
      h6("Map Layers"),
      shinyWidgets::prettyCheckbox(
        ns("show_mpa"), "Show MPAs",
        value = TRUE, status = "primary"
      ),
      shinyWidgets::prettyCheckbox(
        ns("show_vulnerability"), "Vulnerability Index",
        value = TRUE, status = "warning"
      ),
      shinyWidgets::prettyCheckbox(
        ns("show_fisheries"), "Fisheries Dependency",
        value = FALSE, status = "info"
      )
    ),

    bslib::layout_column_wrap(
      width = 1,
      heights_equal = "row",

      # Map
      bslib::card(
        full_screen = TRUE,
        bslib::card_header("Spatial Equity Map"),
        bslib::card_body(
          padding = 0,
          leaflet::leafletOutput(ns("map"), height = "500px")
        )
      ),

      # Overlap analysis
      bslib::card(
        bslib::card_header("Overlap Analysis: Vulnerability vs Conservation Pressure"),
        bslib::card_body(
          plotly::plotlyOutput(ns("overlap_plot"), height = "350px")
        )
      )
    )
  )
}

#' Spatial Equity module server
#' @param id Module namespace id
#' @noRd
mod_spatial_server <- function(id) {
  moduleServer(id, function(input, output, session) {
    # Load mock data
    regions <- reactive({
      data <- mock_nuts2_data()

      # Apply filters
      if (!is.null(input$country) && length(input$country) > 0) {
        data <- data[data$sovereignt %in% input$country, ]
      }
      if (!is.null(input$sea_basin) && input$sea_basin != "All") {
        data <- data[data$sea_basin == input$sea_basin, ]
      }
      if (!is.null(input$ecosystem) && input$ecosystem != "All") {
        data <- data[data$ecosystem_type == input$ecosystem, ]
      }
      data
    })

    mpas <- reactive({ mock_mpa_data() })

    # Update country choices from data
    observe({
      data <- mock_nuts2_data()
      countries <- sort(unique(data$sovereignt))
      shinyWidgets::updatePickerInput(
        session, "country",
        choices = countries
      )
    })

    # Leaflet map
    output$map <- leaflet::renderLeaflet({
      data <- regions()

      pal_vuln <- leaflet::colorNumeric("YlOrRd", domain = c(0, 1))
      pal_fish <- leaflet::colorNumeric("Blues", domain = c(0, 1))

      m <- leaflet::leaflet() |>
        leaflet::addProviderTiles(leaflet::providers$CartoDB.Positron) |>
        leaflet::setView(lng = 15, lat = 50, zoom = 4)

      if (isTRUE(input$show_vulnerability) && nrow(data) > 0) {
        m <- m |>
          leaflet::addPolygons(
            data = data,
            fillColor = ~pal_vuln(vulnerability),
            fillOpacity = 0.6,
            weight = 1,
            color = "#666",
            label = ~paste0(sovereignt, ": Vulnerability ", vulnerability),
            group = "Vulnerability"
          ) |>
          leaflet::addLegend(
            pal = pal_vuln, values = data$vulnerability,
            title = "Vulnerability", position = "bottomright"
          )
      }

      if (isTRUE(input$show_fisheries) && nrow(data) > 0) {
        m <- m |>
          leaflet::addPolygons(
            data = data,
            fillColor = ~pal_fish(fisheries_dep),
            fillOpacity = 0.5,
            weight = 1,
            color = "#333",
            label = ~paste0(sovereignt, ": Fisheries Dep. ", fisheries_dep),
            group = "Fisheries"
          )
      }

      if (isTRUE(input$show_mpa)) {
        mpa_data <- mpas()
        m <- m |>
          leaflet::addPolygons(
            data = mpa_data,
            fillColor = "#41ae76",
            fillOpacity = 0.3,
            weight = 1,
            color = "#2c7fb8",
            label = ~paste0(name, " (", designation, ")"),
            group = "MPAs"
          )
      }

      m |>
        leaflet::addLayersControl(
          overlayGroups = c("Vulnerability", "Fisheries", "MPAs"),
          options = leaflet::layersControlOptions(collapsed = FALSE)
        )
    })

    # Overlap scatter plot
    output$overlap_plot <- plotly::renderPlotly({
      data <- regions()
      if (nrow(data) == 0) return(plotly::plotly_empty())

      df <- sf::st_drop_geometry(data)

      p <- ggplot2::ggplot(df, ggplot2::aes(
        x = conservation_pressure,
        y = vulnerability,
        color = sea_basin,
        text = paste0(sovereignt, "\nBasin: ", sea_basin)
      )) +
        ggplot2::geom_point(size = 3, alpha = 0.7) +
        ggplot2::geom_smooth(method = "lm", se = FALSE, color = "grey40",
                             linetype = "dashed") +
        ggplot2::labs(
          x = "Conservation Pressure",
          y = "Socio-economic Vulnerability",
          color = "Sea Basin"
        ) +
        ggplot2::theme_minimal() +
        ggplot2::annotate(
          "rect", xmin = 0.6, xmax = 1, ymin = 0.6, ymax = 1,
          alpha = 0.1, fill = "red"
        ) +
        ggplot2::annotate(
          "text", x = 0.8, y = 0.95, label = "Equity\nHotspots",
          size = 3, color = "red"
        )

      plotly::ggplotly(p, tooltip = "text")
    })
  })
}
```

---

### Task 7: Write Module 2 — NFF Scenario Explorer

**Files:**
- Create: `R/mod_scenarios.R`

**Step 1: Write R/mod_scenarios.R**

```r
#' Scenarios module UI
#' @param id Module namespace id
#' @noRd
mod_scenarios_ui <- function(id) {
  ns <- NS(id)

  bslib::layout_sidebar(
    sidebar = bslib::sidebar(
      title = "Scenario Settings",
      width = 300,
      h6("NFF Perspective Weights"),
      p(class = "text-muted small",
        "Adjust sliders to set your preferred balance. Values are normalised to 100%."),
      sliderInput(ns("nfn"), "Nature for Nature",
                  min = 0, max = 100, value = 34, step = 1),
      sliderInput(ns("nfs"), "Nature for Society",
                  min = 0, max = 100, value = 33, step = 1),
      sliderInput(ns("nac"), "Nature as Culture",
                  min = 0, max = 100, value = 33, step = 1),
      verbatimTextOutput(ns("weight_sum")),
      hr(),
      selectInput(ns("region"), "Region",
                  choices = c("Baltic", "North Sea", "Atlantic",
                              "Mediterranean", "Black Sea")),
      selectInput(ns("horizon"), "Time Horizon",
                  choices = c("2030", "2040", "2050"),
                  selected = "2050"),
      hr(),
      actionButton(ns("save_scenario"), "Save Scenario",
                   class = "btn-primary w-100",
                   icon = icon("plus")),
      actionButton(ns("clear_scenarios"), "Clear All",
                   class = "btn-outline-secondary w-100 mt-2",
                   icon = icon("trash"))
    ),

    bslib::navset_card_tab(
      title = "Scenario Results",

      bslib::nav_panel(
        "Projections",
        bslib::layout_column_wrap(
          width = 1/2,
          bslib::card(
            bslib::card_header("Indicator Projections"),
            plotly::plotlyOutput(ns("projection_plot"), height = "400px")
          ),
          bslib::card(
            bslib::card_header("GBF Target Compliance"),
            uiOutput(ns("gbf_compliance"))
          )
        )
      ),

      bslib::nav_panel(
        "Compare Scenarios",
        bslib::layout_column_wrap(
          width = 1/2,
          bslib::card(
            bslib::card_header("Radar Comparison (Ecological)"),
            plotly::plotlyOutput(ns("radar_plot"), height = "400px")
          ),
          bslib::card(
            bslib::card_header("Justice Dimensions"),
            plotly::plotlyOutput(ns("bar_plot"), height = "400px")
          )
        )
      )
    )
  )
}

#' Scenarios module server
#' @param id Module namespace id
#' @noRd
mod_scenarios_server <- function(id) {
  moduleServer(id, function(input, output, session) {

    # Normalised weights
    weights <- reactive({
      total <- input$nfn + input$nfs + input$nac
      if (total == 0) total <- 1
      c(NfN = round(input$nfn / total * 100),
        NfS = round(input$nfs / total * 100),
        NaC = round(input$nac / total * 100))
    })

    output$weight_sum <- renderText({
      w <- weights()
      paste0("Normalised: NfN=", w["NfN"], "% NfS=", w["NfS"],
             "% NaC=", w["NaC"], "%")
    })

    # Current scenario data
    current_data <- reactive({
      mock_scenario_data(
        nff_weights = weights(),
        region = input$region
      )
    })

    # Saved scenarios (up to 4)
    saved <- reactiveVal(list())

    observeEvent(input$save_scenario, {
      current <- saved()
      if (length(current) >= 4) {
        showNotification("Maximum 4 scenarios. Clear to add more.",
                         type = "warning")
        return()
      }
      w <- weights()
      label <- paste0("S", length(current) + 1, ": ",
                       w["NfN"], "/", w["NfS"], "/", w["NaC"])
      current[[label]] <- current_data()
      saved(current)
      showNotification(paste("Saved:", label), type = "message")
    })

    observeEvent(input$clear_scenarios, {
      saved(list())
      showNotification("All scenarios cleared", type = "message")
    })

    # Projection plot
    output$projection_plot <- plotly::renderPlotly({
      data <- current_data()
      horizon_year <- as.integer(input$horizon)
      data <- data[data$year <= horizon_year, ]

      p <- ggplot2::ggplot(data, ggplot2::aes(
        x = year, y = value, color = indicator
      )) +
        ggplot2::geom_line(linewidth = 1) +
        ggplot2::geom_point(size = 1) +
        ggplot2::theme_minimal() +
        ggplot2::labs(x = "Year", y = "Index Value", color = "Indicator") +
        ggplot2::scale_color_manual(values = c(
          "Habitat Condition" = "#2c7fb8",
          "Ecosystem Services" = "#41ae76",
          "Livelihoods & Employment" = "#f0ad4e",
          "Equity Score" = "#d9534f"
        ))

      plotly::ggplotly(p)
    })

    # GBF compliance
    output$gbf_compliance <- renderUI({
      w <- weights()
      set.seed(sum(w))
      targets <- data.frame(
        target = paste("Target", c(3, 8, 10, 14, 22)),
        description = c(
          "30x30 Protected Areas",
          "Climate Change Adaptation",
          "Sustainable Agriculture/Fisheries",
          "Mainstreaming Biodiversity",
          "Inclusive Decision-Making"
        ),
        status = sample(c("green", "amber", "red"), 5, replace = TRUE,
                        prob = c(w["NfN"]/100, 0.3, 1 - w["NfN"]/100))
      )

      tagList(
        lapply(seq_len(nrow(targets)), function(i) {
          div(
            class = "d-flex align-items-center mb-2",
            tags$span(class = paste("traffic-light", targets$status[i])),
            tags$strong(targets$target[i]),
            tags$span(class = "ms-2 text-muted", targets$description[i])
          )
        })
      )
    })

    # Radar comparison plot
    output$radar_plot <- plotly::renderPlotly({
      scenarios <- saved()
      if (length(scenarios) == 0) {
        return(plotly::plotly_empty(type = "scatterpolar") |>
                 plotly::layout(title = "Save scenarios to compare"))
      }

      categories <- c("Habitat Condition", "Ecosystem Services",
                       "Livelihoods & Employment", "Equity Score")

      p <- plotly::plot_ly(type = "scatterpolar", fill = "toself")

      for (nm in names(scenarios)) {
        df <- scenarios[[nm]]
        end_vals <- df |>
          dplyr::filter(year == max(year)) |>
          dplyr::pull(value)
        # Normalise to 0-1 range for radar
        end_vals <- pmin(pmax(end_vals, 0), 1)

        p <- p |> plotly::add_trace(
          r = c(end_vals, end_vals[1]),
          theta = c(categories, categories[1]),
          name = nm
        )
      }

      p |> plotly::layout(
        polar = list(radialaxis = list(visible = TRUE, range = c(0, 1)))
      )
    })

    # Stacked bar comparison
    output$bar_plot <- plotly::renderPlotly({
      scenarios <- saved()
      if (length(scenarios) == 0) {
        return(plotly::plotly_empty() |>
                 plotly::layout(title = "Save scenarios to compare"))
      }

      df_list <- lapply(names(scenarios), function(nm) {
        d <- scenarios[[nm]]
        d |>
          dplyr::filter(year == max(year)) |>
          dplyr::mutate(scenario = nm)
      })

      df <- do.call(rbind, df_list)

      p <- ggplot2::ggplot(df, ggplot2::aes(
        x = scenario, y = value, fill = indicator
      )) +
        ggplot2::geom_col(position = "dodge") +
        ggplot2::theme_minimal() +
        ggplot2::labs(x = "Scenario", y = "Final Value", fill = "Dimension") +
        ggplot2::coord_flip()

      plotly::ggplotly(p)
    })
  })
}
```

---

### Task 8: Write Module 3 — Justice Impact Assessment

**Files:**
- Create: `R/mod_justice.R`

**Step 1: Write R/mod_justice.R**

```r
#' Justice Impact Assessment module UI
#' @param id Module namespace id
#' @noRd
mod_justice_ui <- function(id) {
  ns <- NS(id)

  bslib::layout_sidebar(
    sidebar = bslib::sidebar(
      title = "Intervention",
      width = 280,
      selectInput(
        ns("intervention"), "Select Intervention",
        choices = mock_interventions()
      ),
      selectInput(
        ns("target_area"), "Target Area",
        choices = c("Baltic Sea", "North Sea", "Atlantic Coast",
                    "Mediterranean", "Black Sea", "Adriatic",
                    "Aegean", "Celtic Sea")
      ),
      hr(),
      downloadButton(ns("download_report"), "Download Report",
                     class = "btn-primary w-100")
    ),

    tagList(
      # Justice Scorecard
      h5("Justice Scorecard", class = "mb-3"),
      bslib::layout_column_wrap(
        width = 1/2,
        uiOutput(ns("scorecard"))
      ),

      # Gap Analysis
      bslib::card(
        class = "mt-3",
        bslib::card_header("Gap Analysis & Recommendations"),
        bslib::card_body(
          uiOutput(ns("gap_analysis"))
        )
      )
    )
  )
}

#' Justice Impact Assessment module server
#' @param id Module namespace id
#' @noRd
mod_justice_server <- function(id) {
  moduleServer(id, function(input, output, session) {

    scores <- reactive({
      mock_justice_scores(input$intervention)
    })

    # Justice scorecard cards
    output$scorecard <- renderUI({
      df <- scores()
      icons <- c(
        Distributional = "pie-chart",
        Procedural = "people",
        Recognitional = "eye",
        Restorative = "arrow-counterclockwise"
      )

      tagList(
        lapply(seq_len(nrow(df)), function(i) {
          status <- df$status[i]
          score_pct <- round(df$score[i] * 100)
          status_label <- switch(status,
                                 green = "Adequate",
                                 amber = "Needs Attention",
                                 red = "Critical Gap")

          bslib::card(
            class = paste("justice-card", paste0("status-", status)),
            bslib::card_header(
              tags$span(class = paste("traffic-light", status)),
              df$dimension[i]
            ),
            bslib::card_body(
              h3(paste0(score_pct, "%"), class = "mb-1"),
              p(class = "text-muted mb-1", status_label),
              p(class = "small", df$description[i])
            )
          )
        })
      )
    })

    # Gap analysis
    output$gap_analysis <- renderUI({
      df <- scores()
      gaps <- df[df$status != "green", ]

      if (nrow(gaps) == 0) {
        return(div(
          class = "alert alert-success",
          bsicons::bs_icon("check-circle"),
          " All justice dimensions are adequately addressed."
        ))
      }

      recommendations <- list(
        Distributional = list(
          "Consider EMFAF compensation schemes for affected fishing communities",
          "Explore Just Transition Fund eligibility for coastal regions",
          "Implement benefit-sharing mechanisms for ecosystem service gains"
        ),
        Procedural = list(
          "Establish Aarhus Convention-compliant consultation procedures",
          "Include small-scale fishers in management advisory councils",
          "Create participatory mapping exercises with local communities"
        ),
        Recognitional = list(
          "Integrate traditional ecological knowledge in impact assessments",
          "Recognise indigenous and local community territorial rights",
          "Document cultural heritage values in conservation planning"
        ),
        Restorative = list(
          "Assess historical displacement from existing protected areas",
          "Design targeted support for communities with legacy pollution exposure",
          "Establish monitoring of cumulative impact on marginalised groups"
        )
      )

      tagList(
        div(class = "alert alert-warning",
            bsicons::bs_icon("exclamation-triangle"),
            paste0(" ", nrow(gaps), " justice dimension(s) require attention.")),
        lapply(seq_len(nrow(gaps)), function(i) {
          dim_name <- gaps$dimension[i]
          recs <- recommendations[[dim_name]]
          div(
            class = "mb-3",
            h6(
              tags$span(class = paste("traffic-light", gaps$status[i])),
              dim_name, " Justice"
            ),
            tags$ul(
              lapply(recs, function(r) tags$li(r))
            )
          )
        })
      )
    })

    # Download report
    output$download_report <- downloadHandler(
      filename = function() {
        paste0("justice-assessment-",
               gsub(" ", "-", tolower(input$intervention)),
               "-", Sys.Date(), ".html")
      },
      content = function(file) {
        df <- scores()
        # Simple HTML report
        html <- paste0(
          "<html><head><title>Justice Impact Assessment</title>",
          "<style>body{font-family:sans-serif;max-width:800px;margin:auto;padding:2rem}",
          ".green{color:#41ae76}.amber{color:#f0ad4e}.red{color:#d9534f}",
          "table{border-collapse:collapse;width:100%}td,th{border:1px solid #ddd;padding:8px}</style>",
          "</head><body>",
          "<h1>Justice Impact Assessment</h1>",
          "<p><strong>Intervention:</strong> ", input$intervention, "</p>",
          "<p><strong>Target Area:</strong> ", input$target_area, "</p>",
          "<p><strong>Date:</strong> ", Sys.Date(), "</p>",
          "<table><tr><th>Dimension</th><th>Score</th><th>Status</th></tr>",
          paste0(
            "<tr><td>", df$dimension, "</td>",
            "<td>", round(df$score * 100), "%</td>",
            "<td class='", df$status, "'>",
            ifelse(df$status == "green", "Adequate",
                   ifelse(df$status == "amber", "Needs Attention", "Critical Gap")),
            "</td></tr>",
            collapse = ""
          ),
          "</table>",
          "<p><em>Generated by NatureJust-EU</em></p>",
          "</body></html>"
        )
        writeLines(html, file)
      }
    )
  })
}
```

---

### Task 9: Write Module 4 — Governance & Funding Alignment

**Files:**
- Create: `R/mod_governance.R`

**Step 1: Write R/mod_governance.R**

```r
#' Governance & Funding module UI
#' @param id Module namespace id
#' @noRd
mod_governance_ui <- function(id) {
  ns <- NS(id)

  tagList(
    bslib::navset_card_tab(
      title = "Governance & Funding Alignment",

      bslib::nav_panel(
        "Funding Matrix",
        bslib::card_body(
          p(class = "text-muted",
            "Eligibility of conservation interventions across EU funding instruments."),
          DT::dataTableOutput(ns("funding_table"))
        )
      ),

      bslib::nav_panel(
        "CFP Alignment",
        bslib::layout_sidebar(
          sidebar = bslib::sidebar(
            title = "Check Alignment",
            selectInput(ns("cfp_measure"), "Conservation Measure",
                        choices = mock_interventions())
          ),
          bslib::card(
            bslib::card_header("Common Fisheries Policy Alignment"),
            bslib::card_body(
              uiOutput(ns("cfp_result"))
            )
          )
        )
      ),

      bslib::nav_panel(
        "Stakeholder Tracker",
        bslib::card_body(
          p(class = "text-muted",
            "Track stakeholder consultation against GBF Target 22 requirements."),
          uiOutput(ns("stakeholder_checklist"))
        )
      )
    )
  )
}

#' Governance & Funding module server
#' @param id Module namespace id
#' @noRd
mod_governance_server <- function(id) {
  moduleServer(id, function(input, output, session) {

    # Funding matrix table
    output$funding_table <- DT::renderDataTable({
      df <- mock_funding_matrix()
      DT::datatable(
        df,
        options = list(
          pageLength = 10,
          dom = "ft",
          columnDefs = list(list(className = "dt-center", targets = 1:5))
        ),
        rownames = FALSE
      ) |>
        DT::formatStyle(
          columns = c("EMFAF", "LIFE", "Cohesion Fund", "EARDF",
                       "Just Transition Fund"),
          backgroundColor = DT::styleEqual(
            c("Eligible", "Partial", "Not eligible"),
            c("#d4edda", "#fff3cd", "#f8d7da")
          )
        )
    })

    # CFP alignment check
    output$cfp_result <- renderUI({
      measure <- input$cfp_measure
      set.seed(nchar(measure))

      alignment <- sample(c("aligned", "partial", "conflict"), 1,
                          prob = c(0.4, 0.35, 0.25))

      status_class <- switch(alignment,
                             aligned = "alert-success",
                             partial = "alert-warning",
                             conflict = "alert-danger")

      status_icon <- switch(alignment,
                            aligned = "check-circle",
                            partial = "exclamation-triangle",
                            conflict = "x-circle")

      status_text <- switch(alignment,
                            aligned = "This measure is fully aligned with current CFP management plans.",
                            partial = "This measure requires modifications to align with CFP quota allocations.",
                            conflict = "This measure conflicts with existing CFP management plans and requires derogation.")

      mock_details <- switch(alignment,
                             aligned = list(
                               "Compatible with existing Total Allowable Catch (TAC) regulations",
                               "Supports CFP discard ban implementation",
                               "Aligns with Maximum Sustainable Yield (MSY) objectives"
                             ),
                             partial = list(
                               "May require adjustment to regional fishing effort limits",
                               "Partial overlap with EMFAF fleet adaptation measures",
                               "Needs coordination with Regional Advisory Councils"
                             ),
                             conflict = list(
                               "Conflicts with allocated fishing quotas in target area",
                               "Requires Article 11 MSFD/CFP coordination procedure",
                               "May trigger compensation obligations under EMFAF Article 17"
                             ))

      tagList(
        div(class = paste("alert", status_class),
            bsicons::bs_icon(status_icon),
            paste0(" ", status_text)),
        tags$ul(
          lapply(mock_details, function(d) tags$li(d))
        )
      )
    })

    # Stakeholder tracker
    output$stakeholder_checklist <- renderUI({
      stakeholders <- c(
        "National Fisheries Authorities",
        "Regional/Local Government",
        "Small-Scale Fishers Associations",
        "Industrial Fishing Fleet Representatives",
        "Environmental NGOs",
        "Indigenous & Local Community Representatives",
        "Marine Scientists & Researchers",
        "Tourism & Recreation Sector",
        "Port Authorities",
        "Youth & Future Generations Representatives"
      )

      set.seed(42)
      consulted <- sample(c(TRUE, FALSE), length(stakeholders),
                          replace = TRUE, prob = c(0.5, 0.5))

      n_consulted <- sum(consulted)
      n_total <- length(stakeholders)
      pct <- round(n_consulted / n_total * 100)

      tagList(
        bslib::value_box(
          title = "Consultation Progress",
          value = paste0(n_consulted, " / ", n_total),
          showcase = bsicons::bs_icon("people-fill"),
          theme = if (pct >= 80) "success" else if (pct >= 50) "warning" else "danger",
          p(paste0(pct, "% of stakeholder groups consulted"))
        ),
        div(class = "mt-3",
            lapply(seq_along(stakeholders), function(i) {
              div(
                class = "d-flex align-items-center mb-2 p-2 border rounded",
                tags$span(
                  class = paste("traffic-light",
                                if (consulted[i]) "green" else "red")
                ),
                tags$span(stakeholders[i]),
                if (!consulted[i]) {
                  tags$span(class = "ms-auto badge bg-warning",
                            "Not yet consulted")
                }
              )
            })
        )
      )
    })
  })
}
```

---

### Task 10: Write Module 5 — Indicator Dashboard

**Files:**
- Create: `R/mod_dashboard.R`

**Step 1: Write R/mod_dashboard.R**

```r
#' Indicator Dashboard module UI
#' @param id Module namespace id
#' @noRd
mod_dashboard_ui <- function(id) {
  ns <- NS(id)

  bslib::layout_sidebar(
    sidebar = bslib::sidebar(
      title = "Settings",
      width = 260,
      selectInput(
        ns("region"), "Region",
        choices = c("Baltic", "North Sea", "Atlantic",
                    "Mediterranean", "Black Sea")
      ),
      shinyWidgets::pickerInput(
        ns("indicators"), "Indicators",
        choices = c(
          "Marine Biodiversity Index",
          "Habitat Condition Score",
          "Ecosystem Services Value",
          "Community Wellbeing Index",
          "Governance Effectiveness"
        ),
        selected = c("Marine Biodiversity Index", "Habitat Condition Score"),
        multiple = TRUE,
        options = shinyWidgets::pickerOptions(actionsBox = TRUE)
      ),
      hr(),
      downloadButton(ns("download_csv"), "Export CSV",
                     class = "btn-outline-primary w-100")
    ),

    tagList(
      # Time series
      bslib::card(
        full_screen = TRUE,
        bslib::card_header("Indicator Time Series"),
        bslib::card_body(
          plotly::plotlyOutput(ns("timeseries_plot"), height = "400px")
        )
      ),

      bslib::layout_column_wrap(
        width = 1/2,

        # GBF compliance
        bslib::card(
          bslib::card_header("GBF Target Compliance"),
          bslib::card_body(
            DT::dataTableOutput(ns("compliance_table"))
          )
        ),

        # Equity trend
        bslib::card(
          bslib::card_header("Equity Trend Decomposition"),
          bslib::card_body(
            plotly::plotlyOutput(ns("equity_plot"), height = "300px")
          )
        )
      )
    )
  )
}

#' Indicator Dashboard module server
#' @param id Module namespace id
#' @noRd
mod_dashboard_server <- function(id) {
  moduleServer(id, function(input, output, session) {

    data <- reactive({
      mock_indicator_timeseries(input$region)
    })

    filtered_data <- reactive({
      df <- data()
      if (!is.null(input$indicators) && length(input$indicators) > 0) {
        df <- df[df$indicator %in% input$indicators, ]
      }
      df
    })

    # Time series with confidence bands
    output$timeseries_plot <- plotly::renderPlotly({
      df <- filtered_data()
      if (nrow(df) == 0) return(plotly::plotly_empty())

      p <- ggplot2::ggplot(df, ggplot2::aes(x = year, color = indicator,
                                             fill = indicator)) +
        ggplot2::geom_ribbon(ggplot2::aes(ymin = lower, ymax = upper),
                             alpha = 0.15, color = NA) +
        ggplot2::geom_line(ggplot2::aes(y = value), linewidth = 1) +
        ggplot2::geom_point(ggplot2::aes(y = value), size = 1.5) +
        ggplot2::theme_minimal() +
        ggplot2::labs(x = "Year", y = "Index Value",
                      color = "Indicator", fill = "Indicator")

      plotly::ggplotly(p)
    })

    # GBF compliance table
    output$compliance_table <- DT::renderDataTable({
      df <- data()
      latest <- df[df$year == max(df$year), ]

      compliance <- data.frame(
        Indicator = latest$indicator,
        `Current Value` = round(latest$value, 3),
        `GBF Target` = latest$gbf_target,
        Status = ifelse(latest$value >= latest$gbf_target, "Met",
                        ifelse(latest$value >= latest$gbf_target * 0.8,
                               "Partly Met", "Not Met")),
        check.names = FALSE
      )

      DT::datatable(
        compliance,
        options = list(dom = "t", pageLength = 10),
        rownames = FALSE
      ) |>
        DT::formatStyle(
          "Status",
          backgroundColor = DT::styleEqual(
            c("Met", "Partly Met", "Not Met"),
            c("#d4edda", "#fff3cd", "#f8d7da")
          )
        )
    })

    # Equity trend decomposition
    output$equity_plot <- plotly::renderPlotly({
      df <- data()
      eco <- df[df$indicator == "Habitat Condition Score", ]
      equity <- df[df$indicator == "Community Wellbeing Index", ]

      if (nrow(eco) == 0 || nrow(equity) == 0) {
        return(plotly::plotly_empty())
      }

      combined <- data.frame(
        year = eco$year,
        ecological = eco$value,
        equity = equity$value
      )

      p <- plotly::plot_ly(combined, x = ~year) |>
        plotly::add_trace(y = ~ecological, name = "Ecological",
                          type = "scatter", mode = "lines+markers",
                          line = list(color = "#2c7fb8")) |>
        plotly::add_trace(y = ~equity, name = "Equity",
                          type = "scatter", mode = "lines+markers",
                          line = list(color = "#41ae76")) |>
        plotly::layout(
          yaxis = list(title = "Index Value"),
          xaxis = list(title = "Year"),
          legend = list(orientation = "h", y = -0.15)
        )

      p
    })

    # CSV export
    output$download_csv <- downloadHandler(
      filename = function() {
        paste0("naturejust-indicators-", input$region, "-",
               Sys.Date(), ".csv")
      },
      content = function(file) {
        utils::write.csv(filtered_data(), file, row.names = FALSE)
      }
    )
  })
}
```

---

### Task 11: Write utils and dev helpers

**Files:**
- Create: `R/utils_helpers.R`
- Create: `dev/01_start.R`
- Create: `dev/run_dev.R`

**Step 1: Write R/utils_helpers.R**

```r
#' Create a traffic light HTML span
#' @param status Character: "green", "amber", or "red"
#' @return shiny.tag
#' @noRd
traffic_light <- function(status) {
  htmltools::tags$span(class = paste("traffic-light", status))
}
```

**Step 2: Write dev/01_start.R**

```r
# Install dependencies
# Run this once after cloning the repo

install.packages(c(
  "shiny", "golem", "bslib", "bsicons", "config",
  "leaflet", "sf", "plotly", "ggplot2",
  "dplyr", "tidyr", "purrr",
  "DT", "shinyWidgets",
  "rnaturalearth", "rnaturalearthdata",
  "rmarkdown", "knitr", "htmltools",
  "testthat", "devtools"
))
```

**Step 3: Write dev/run_dev.R**

```r
# Run the app in development mode
# Source this file or run from RStudio

options("golem.app.prod" = FALSE)
golem::run_dev()
```

---

### Task 12: Write Dockerfile

**Files:**
- Create: `Dockerfile`

**Step 1: Write Dockerfile**

```dockerfile
FROM rocker/shiny-verse:4.3.2

RUN apt-get update && apt-get install -y \
    libgdal-dev \
    libgeos-dev \
    libproj-dev \
    libudunits2-dev \
    && rm -rf /var/lib/apt/lists/*

RUN install2.r --error --skipinstalled \
    golem config bslib bsicons \
    leaflet sf plotly \
    DT shinyWidgets \
    rnaturalearth rnaturalearthdata \
    rmarkdown

COPY . /srv/shiny-server/NatureJust
WORKDIR /srv/shiny-server/NatureJust

RUN R -e "devtools::install_deps(dependencies = TRUE)"
RUN R -e "devtools::install()"

EXPOSE 3838

CMD ["R", "-e", "NatureJust::run_app(host='0.0.0.0', port=3838)"]
```

---

### Task 13: Write smoke tests

**Files:**
- Create: `tests/testthat.R`
- Create: `tests/testthat/test-golem-recommended.R`
- Create: `tests/testthat/test-modules.R`

**Step 1: Write tests/testthat.R**

```r
library(testthat)
library(NatureJust)

test_check("NatureJust")
```

**Step 2: Write tests/testthat/test-golem-recommended.R**

```r
test_that("app ui", {
  ui <- app_ui()
  golem::expect_shinytaglist(ui)
})

test_that("app server", {
  server <- app_server
  expect_type(server, "closure")
})
```

**Step 3: Write tests/testthat/test-modules.R**

```r
test_that("mod_home_ui returns taglist", {
  ui <- mod_home_ui("test")
  expect_true(inherits(ui, "shiny.tag.list") || inherits(ui, "shiny.tag"))
})

test_that("mod_spatial_ui returns taglist", {
  ui <- mod_spatial_ui("test")
  expect_true(inherits(ui, "shiny.tag.list") || inherits(ui, "shiny.tag"))
})

test_that("mod_scenarios_ui returns taglist", {
  ui <- mod_scenarios_ui("test")
  expect_true(inherits(ui, "shiny.tag.list") || inherits(ui, "shiny.tag"))
})

test_that("mod_justice_ui returns taglist", {
  ui <- mod_justice_ui("test")
  expect_true(inherits(ui, "shiny.tag.list") || inherits(ui, "shiny.tag"))
})

test_that("mod_governance_ui returns taglist", {
  ui <- mod_governance_ui("test")
  expect_true(inherits(ui, "shiny.tag.list") || inherits(ui, "shiny.tag"))
})

test_that("mod_dashboard_ui returns taglist", {
  ui <- mod_dashboard_ui("test")
  expect_true(inherits(ui, "shiny.tag.list") || inherits(ui, "shiny.tag"))
})

test_that("mock data functions work", {
  expect_s3_class(mock_nuts2_data(), "sf")
  expect_s3_class(mock_mpa_data(), "sf")
  expect_s3_class(mock_scenario_data(), "data.frame")
  expect_s3_class(mock_justice_scores(), "data.frame")
  expect_type(mock_interventions(), "character")
  expect_s3_class(mock_funding_matrix(), "data.frame")
  expect_s3_class(mock_indicator_timeseries(), "data.frame")
})
```

---

### Task 14: Verify app loads

**Step 1: Open RStudio, set working directory to NatureJust**

**Step 2: Install dependencies**

Run in R console:
```r
source("dev/01_start.R")
```

**Step 3: Load and run the app**

Run in R console:
```r
devtools::load_all()
run_app()
```

Expected: Browser opens with NatureJust-EU navbar, Home tab showing NFF triangle and module overview cards.

**Step 4: Click through all tabs**

Verify each module renders without errors.

**Step 5: Run tests**

```r
devtools::test()
```

Expected: All tests pass.
